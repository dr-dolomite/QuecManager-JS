#!/bin/sh /etc/rc.common

# WebSocket Setup Service
# Procd service wrapper for WebSocket UCI and SSL certificate setup
# Runs the standalone websocat_setup.sh script before quecmanager_services (START=49)
# Author: dr-dolomite
# Date: 2025-11-18

START=48
STOP=51

USE_PROCD=1

SETUP_SCRIPT="/www/cgi-bin/services/websocat_setup.sh"

start_service() {
    echo "Starting WebSocket setup service..."
    
    # Check if setup script exists
    if [ ! -f "$SETUP_SCRIPT" ]; then
        logger -t websocat_setup "ERROR: Setup script not found at $SETUP_SCRIPT"
        return 1
    fi
    
    # Run the setup script as a procd service
    procd_open_instance
    procd_set_param command "$SETUP_SCRIPT"
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
    
    echo "WebSocket setup service started"
}

stop_service() {
    echo "WebSocket setup service stopping (nothing to stop)"
}

service_triggers() {
    procd_add_reload_trigger "quecmanager"
}